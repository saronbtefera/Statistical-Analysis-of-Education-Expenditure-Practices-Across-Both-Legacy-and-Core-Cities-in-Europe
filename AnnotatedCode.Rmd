---
title: "Appendix"
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
header-includes:
- \renewcommand*\familydefault{\sfdefault} %% this picks a sans serif font
- \usepackage[T1]{fontenc}
- \pagenumbering{roman}
---

```{r include = FALSE}
library(ggplot2)

library(GGally)


library(car)
```


```{r echo = TRUE, results = 'hide', message = FALSE, warning = FALSE, fig.show = 'hide'}
#read in data
data1 <- read.csv("dae_23.csv")
head(data1)

#subset data with variables of interest 
data <- data.frame(data1[,c("city_types", "cpi", "rev_total", "own_source_rev",
                            "rev_utility", "spending_direct", 
                            "education_services", "debt_outstanding", 
                            "cash_holdings")])

#summarize variables of interest 
summary(data)


# pairs plot with log transformation
plot_frame1 <- data.frame("log(Education Expenditures)" = log(data$education_services),
                          "direct total expenditures" = data$spending_direct,
                          "outstanding debt" = data$debt_outstanding, 
                          "cash holdings" = data$cash_holdings,
                          "CPI" = data$cpi,
                          "total revenue" = data$rev_total,
                          "Rev Gen by City" = data$own_source_rev, 
                          "Rev Gen from Utility" = data$rev_utility,
                          "City Types" = data$city_types)
ggpairs(plot_frame1, aes(color=data$city_types, alpha=100))


#functional relationship lowess smooths plots

plot1 <- (ggplot(data, aes(x= spending_direct, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="direct total expenditures", y="log(education expenditures)"))
plot1

plot2 <- (ggplot(data, aes(x=debt_outstanding, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="debt outstanding", y="log(education expenditures)"))
plot2

plot3 <- (ggplot(data, aes(x= cash_holdings, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="cash holdings", y="log(education expenditures)"))
plot3

plot4 <- (ggplot(data, aes(x=cpi, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="cpi", y="log(education expenditures)"))
plot4

plot5 <- (ggplot(data, aes(x= rev_total, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="total revenue", y="log(education expenditures)"))
plot5

plot6 <- (ggplot(data, aes(x= own_source_rev, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="revenue generated by city", y="log(education expenditures)"))
plot6

plot7 <- (ggplot(data, aes(x= rev_utility, y=log(education_services) ), color=city_types) +
  #geom_point() + 
  geom_smooth(method=loess, aes(fill=city_types)) +
 labs(x="revenue generated by utility", y="log(education expenditures)"))
plot7


#box-cox transformation

#with correlated variables (direct total expenditures and total revenue)
options(repr.plot.width=5, repr.plot.height=5)
boxCox(lm(education_services ~ cpi + own_source_rev + rev_utility + debt_outstanding + cash_holdings 
          + spending_direct + rev_total+ city_types, data=data))

#without correlated variables (direct total expenditures and total revenue)
options(repr.plot.width=5, repr.plot.height=5)
boxCox(lm(education_services ~ cpi + own_source_rev + rev_utility + debt_outstanding + cash_holdings 
          + city_types, data=data))

#VIF with direct total expenditures and total revenue
fit_mc <- lm(log(education_services) ~ spending_direct + 
                                        own_source_rev +
                                        rev_total +
                                        cash_holdings +
                                        rev_utility +
                                        cpi +
                                        debt_outstanding + 
                                        city_types,
                                        data = data)

print(vif(fit_mc))
print(paste("max VIF:", max(vif(fit_mc))))

print(paste("mean VIF:", mean(vif(fit_mc))))

#VIF without direct total expenditures and total revenue 
fit_mc <- lm(log(education_services) ~ #spending_direct + 
                                        own_source_rev +
                                        #rev_total +
                                        cash_holdings +
                                        rev_utility +
                                        cpi +
                                        debt_outstanding + 
                                        city_types,
                                        data = data)

print(vif(fit_mc))
print(paste("max VIF:", max(vif(fit_mc))))

print(paste("mean VIF:", mean(vif(fit_mc))))

#fit full quadratic model and reduced linear model  
fit <- lm(log(data$education_services) ~ data$city_types +
                    data$debt_outstanding +
                    I(data$debt_outstanding^2) +
                    data$city_types:data$debt_outstanding +
                    data$city_types:I(data$debt_outstanding^2) +
                   
                    data$cash_holdings + 
                    I(data$cash_holdings^2)+
                    data$city_types:data$cash_holdings +
                    data$city_types:I(data$cash_holdings^2)+
                      
                    data$cpi + 
                    I(data$cpi^2) +
                    data$city_types:data$cpi +
                    data$city_types:I(data$cpi^2) + 
                      
                    data$own_source_rev + 
                    I(data$own_source_rev^2) +
                    data$city_types:data$own_source_rev +
                    data$city_types:I(data$own_source_rev^2) +
                      
                    data$rev_utility + 
                    I(data$rev_utility^2)+
                    data$city_types:data$rev_utility +
                    data$city_types:I(data$rev_utility^2)+
          
          
                    data$cash_holdings:data$own_source_rev +
                    I(data$cash_holdings^2):I(data$own_source_rev^2) +
            
                     data$debt_outstanding:data$own_source_rev +
                    I(data$debt_outstanding^2):I(data$own_source_rev^2) +
            
          
                     data$cash_holdings:data$rev_utility +
                    I(data$cash_holdings^2):I(data$rev_utility^2) +
            
                     data$debt_outstanding:data$rev_utility +
                    I(data$debt_outstanding^2):I(data$rev_utility^2) 
          
                    )

fit_reduced <- lm(log(data$education_services) ~ data$city_types +
                    data$debt_outstanding +
                    data$city_types:data$debt_outstanding +
                    
                    data$cash_holdings + 
                    data$city_types:data$cash_holdings +
                    
                    data$cpi + 
                    data$city_types:data$cpi + 
                    
                    data$own_source_rev + 
                    data$city_types:data$own_source_rev + 
                    
                    data$rev_utility +
                    data$city_types:data$rev_utility +
                  
                   
                    data$cash_holdings:data$own_source_rev +
                    data$debt_outstanding:data$own_source_rev +
                  
                    data$cash_holdings:data$rev_utility +
                    data$debt_outstanding:data$rev_utility 
              )

#determine if quadratic or linear by F-test 
anova(fit_reduced, fit)

#select model by AIC 
step_fit <- step(fit)

#check if assumptions are true 
plot(step_fit, which=c(1,2,3))

#F-test on entire model and t-tests on parameter coefficients 
summary(step_fit)

#Bonferoni confidence intervals (alpha = 0.05) 
g = 24
x <- 0.05 / (2*g)
x
#x = 0.001
confint(step_fit, level = (1-0.001))
```

##### Detecting Multicollinearity 

VIF values were used as a formal diagnostic of multicollinearity. I assessed multicollinearity using the VIF values of a fit without the interactions and powers so I could detect multicollinearity between my main variables. I later proceeded with the quadratic model that included the powers and interactions.

```{r echo = FALSE, message = FALSE, warning = FALSE}
#VIF with direct total expenditures and total revenue 
fit_mc <- lm(log(education_services) ~ spending_direct + 
                                        own_source_rev +
                                        rev_total +
                                        cash_holdings +
                                        rev_utility +
                                        cpi +
                                        debt_outstanding + 
                                        city_types,
                                        data = data)

print(vif(fit_mc))
print(paste("max VIF:", max(vif(fit_mc))))

print(paste("mean VIF:", mean(vif(fit_mc))))

#VIF without direct total expenditures and total revenue 
fit_mc <- lm(log(education_services) ~ #spending_direct + 
                                        own_source_rev +
                                        #rev_total +
                                        cash_holdings +
                                        rev_utility +
                                        cpi +
                                        debt_outstanding + 
                                        city_types,
                                        data = data)

print(vif(fit_mc))
print(paste("max VIF:", max(vif(fit_mc))))

print(paste("mean VIF:", mean(vif(fit_mc))))
```

##### Reduced vs Full Model 

An ANOVA F-test was used to determine if a quadratic or linear functional relationship was necessary. A reduced linear model and a full quadratic model were fit. The results of the F-tests were significant which suggests that the quadratic functional relationship was necessary.

```{r echo = FALSE, message = FALSE, warning = FALSE}
anova(fit_reduced, fit)
```

##### Description of Variables\


###### year 
###### id_city 
###### city_population 
###### city_types: Core or legacy city
###### cpi: consumer price index  
###### rev_total: total revenue
###### own_source_rev: revenue generated by the city itself
###### rev_utility: revenue generated from utility
###### spending_direct: direct total expenditures
###### education_services: education expenditures
###### social_services: social services expenditures
###### transportation: transportation expenditures
###### public_safety: public_safety expenditures
###### envir_housing: environment and housing expenditures
###### spending_utility: utility expenditures
###### sp_empl_retire_tr: employee retirement trust expenditures
###### debt_outstanding: Outstanding debt
###### cash_holdings: Cash holdings


